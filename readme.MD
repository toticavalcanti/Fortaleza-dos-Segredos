# üè∞ Fortaleza dos Segredos - Kubernetes Security Demo

Este projeto demonstra as melhores pr√°ticas de seguran√ßa no Kubernetes atrav√©s de um cen√°rio l√∫dico onde uma "fortaleza" protege um segredo que s√≥ pode ser acessado por um "explorador" autorizado.

## üéØ Objetivos de Aprendizado

- **RBAC (Role-Based Access Control)**: Implementar o princ√≠pio do menor privil√©gio
- **ServiceAccounts**: Dar identidade espec√≠fica aos pods
- **NetworkPolicies**: Isolar tr√°fego entre servi√ßos
- **SecurityContext**: Endurecer cont√™ineres (sem root, readonly filesystem)
- **Secrets**: Proteger dados sens√≠veis
- **Resource Limits**: Controlar uso de recursos

## üèóÔ∏è Arquitetura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    NetworkPolicy    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Explorador    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> ‚îÇ   Fortaleza     ‚îÇ
‚îÇ  (Autorizado)   ‚îÇ      PERMITE        ‚îÇ    (API)        ‚îÇ
‚îÇ                 ‚îÇ                     ‚îÇ                 ‚îÇ
‚îÇ ServiceAccount  ‚îÇ                     ‚îÇ ServiceAccount  ‚îÇ
‚îÇ + RBAC Role     ‚îÇ                     ‚îÇ + Minimal RBAC  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                ‚îÇ
                                                ‚îÇ l√™
                                                ‚ñº
                                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                        ‚îÇ     Secret      ‚îÇ
                                        ‚îÇ (mensagem       ‚îÇ
                                        ‚îÇ  protegida)     ‚îÇ
                                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    NetworkPolicy
‚îÇ   Pod Intruso   ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄX‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> Fortaleza (BLOQUEADO)
‚îÇ (N√£o autorizado)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìÅ Estrutura do Projeto

```
terraform-k8s-security/
‚îú‚îÄ‚îÄ main.tf                 # Provider e configura√ß√£o principal
‚îú‚îÄ‚îÄ variables.tf            # Vari√°veis do projeto
‚îú‚îÄ‚îÄ locals.tf              # Valores locais e utilit√°rios
‚îú‚îÄ‚îÄ secrets.tf             # Secrets e ConfigMaps
‚îú‚îÄ‚îÄ rbac.tf                # ServiceAccounts, Roles e RoleBindings
‚îú‚îÄ‚îÄ deployments.tf         # Deployments com SecurityContext
‚îú‚îÄ‚îÄ services.tf            # Services e exposi√ß√£o
‚îú‚îÄ‚îÄ network_policy.tf      # Pol√≠ticas de rede
‚îú‚îÄ‚îÄ outputs.tf             # Outputs e comandos √∫teis
‚îú‚îÄ‚îÄ terraform.tfvars.example  # Exemplo de configura√ß√£o
‚îî‚îÄ‚îÄ README.md              # Esta documenta√ß√£o
```

## üöÄ Como Usar

### 1. Pr√©-requisitos

- Terraform >= 1.0
- Cluster Kubernetes funcionando
- kubectl configurado
- CNI que suporte NetworkPolicies (Calico, Cilium, etc.)

### 2. Configura√ß√£o

```bash
# Clone ou baixe os arquivos do projeto
cd terraform-k8s-security

# Copie o arquivo de exemplo e configure
cp terraform.tfvars.example terraform.tfvars
nano terraform.tfvars  # Ajuste conforme seu ambiente
```

### 3. Deploy

```bash
# Inicializar Terraform
terraform init

# Planejar mudan√ßas
terraform plan

# Aplicar configura√ß√µes
terraform apply
```

### 4. Teste da Seguran√ßa

#### ‚úÖ Teste Autorizado (deve funcionar)

```bash
# Pegar nome do pod explorador
kubectl get pods -n fortress-security -l app=explorer

# Acessar o segredo do explorador (autorizado)
kubectl exec -n fortress-security deployment/explorer -- \
  wget -qO- http://fortress-service:3000/secret

# Resultado esperado: Mensagem secreta √© exibida
```

#### ‚ùå Teste N√£o Autorizado (deve ser bloqueado)

```bash
# Criar pod intruso
kubectl run intruso --image=busybox:1.36 --restart=Never -n fortress-security -- \
  sh -c "wget -qO- http://fortress-service:3000/secret || echo 'ACESSO BLOQUEADO'"

# Verificar logs
kubectl logs intruso -n fortress-security

# Resultado esperado: Timeout ou erro de conex√£o (bloqueado pela NetworkPolicy)

# Limpar
kubectl delete pod intruso -n fortress-security
```

#### üîç Verifica√ß√µes Adicionais

```bash
# Verificar todos os recursos criados
terraform output

# Ver pods em execu√ß√£o
kubectl get pods -n fortress-security -o wide

# Ver network policies
kubectl get networkpolicies -n fortress-security

# Ver RBAC
kubectl get serviceaccounts,roles,rolebindings -n fortress-security

# Entrar no explorador para testes manuais
kubectl exec -it -n fortress-security deployment/explorer -- sh
```

## üõ°Ô∏è Recursos de Seguran√ßa Implementados

### 1. **RBAC (Role-Based Access Control)**

- **ServiceAccount espec√≠fico** para cada componente
- **Roles com permiss√µes m√≠nimas** (princ√≠pio do menor privil√©gio)
- **RoleBindings** conectando SAs √†s Roles apropriadas

### 2. **NetworkPolicies**

- **Fortaleza**: Aceita conex√µes apenas do explorador
- **Explorador**: Pode acessar apenas a fortaleza
- **Default Deny**: Bloqueia todo tr√°fego n√£o especificado
- **System Traffic**: Permite tr√°fego necess√°rio do Kubernetes

### 3. **SecurityContext**

- **Non-root user**: Todos os containers rodam como usu√°rio n√£o-root
- **Read-only filesystem**: Sistema de arquivos somente leitura
- **No privilege escalation**: Impede escala√ß√£o de privil√©gios
- **Dropped capabilities**: Remove todas as capabilities desnecess√°rias
- **Seccomp profile**: Usa perfil de seguran√ßa padr√£o

### 4. **Secrets Management**

- **Dados sens√≠veis** armazenados em Secrets
- **Inje√ß√£o via vari√°veis** de ambiente
- **Base64 encoding** autom√°tico
- **Separa√ß√£o** entre dados sens√≠veis e configura√ß√µes

### 5. **Resource Limits**

- **CPU e Memory limits** definidos
- **Requests appropriados** para scheduling
- **Prevent resource abuse** e DoS

## üîß Personaliza√ß√£o

### Vari√°veis Principais

```hcl
# terraform.tfvars
namespace = "meu-namespace"
secret_message = "Minha mensagem secreta personalizada"
fortress_replicas = 2
explorer_replicas = 1

fortress_resources = {
  requests = { cpu = "200m", memory = "256Mi" }
  limits   = { cpu = "500m", memory = "512Mi" }
}
```

### Adicionando Novos Recursos

1. **Mais aplica√ß√µes**: Adicione novos deployments seguindo o padr√£o
2. **Ingress**: Configure exposi√ß√£o externa se necess√°rio
3. **Monitoring**: Habilite ServiceMonitor para Prometheus
4. **Certificados**: Configure cert-manager para TLS

## üß™ Cen√°rios de Teste

### Teste 1: Acesso Autorizado
```bash
kubectl exec -n fortress-security deployment/explorer -- \
  curl -s http://fortress-service:3000/secret
```

### Teste 2: Health Check
```bash
kubectl exec -n fortress-security deployment/explorer -- \
  curl -s http://fortress-service:3000/health
```

### Teste 3: Verificar Logs
```bash
kubectl logs -n fortress-security deployment/fortress-api
kubectl logs -n fortress-security deployment/explorer
```

### Teste 4: Pod N√£o Autorizado
```bash
kubectl run test-unauthorized --image=alpine:latest --rm -it -n fortress-security -- \
  sh -c "apk add curl && curl -m 5 http://fortress-service:3000/secret || echo 'BLOCKED'"
```

## üßπ Limpeza

```bash
# Remover todos os recursos
terraform destroy

# Confirmar limpeza
kubectl get all -n fortress-security
```

## üìö Pr√≥ximos Passos

1. **Pod Security Standards**: Implement PSS/PSA
2. **OPA Gatekeeper**: Pol√≠ticas de compliance automatizadas
3. **Falco**: Runtime security monitoring
4. **cert-manager**: Certificados TLS autom√°ticos
5. **Istio Service Mesh**: mTLS autom√°tico entre servi√ßos

## ü§ù Contribuindo

1. Fork o projeto
2. Crie uma branch para sua feature
3. Commit suas mudan√ßas
4. Push para a branch
5. Abra um Pull Request

## üìù Licen√ßa

Este projeto √© para fins educacionais e demonstra√ß√£o de conceitos de seguran√ßa no Kubernetes.

---

**‚ö†Ô∏è Aviso**: Este √© um projeto educacional. Em ambiente de produ√ß√£o, sempre revise e teste as configura√ß√µes de seguran√ßa conforme suas necessidades espec√≠ficas.